<html lang="en">
  <head>
    <title>Kamon | Documentation</title>

<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kamon is a set of tools that will help you monitor your reactive applications">

<!--<link rel="stylesheet" href="/assets/css/syntax-highlight.css">-->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/css/prism.css">
<link rel="stylesheet" href="/assets/css/styles.css">
<link rel="stylesheet" href="/assets/css/kamon.css">


<link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon">
<link href="https://plus.google.com/107736741680270898032?rel=author">
<link rel="alternate" type="application/rss+xml" title="Kamon Teamblog Feed" href="/teamblog/rss/">

<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

  </head>
  <body>
    <nav class="navbar navbar-default kamon-navbar">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-12 col-md-3">
          <a href="/documentation/get-started/">
            <img class="kamon-logo-image" alt="Kamon" src="/assets/img/kamon-logo-latest.svg">
          </a>
      </div>

      <div class="col-12 col-md-9">
        <div class="row justify-content-end align-items-center navigation-links">
            <div class="wip-warning col-12 col-md-4">
              WARNING: We are updating and fixing all docs around!
            </div>
            <a class="col-12 col-md-4 col-lg-3" href="/documentation/get-started/">
              <span class="nav-link">DOCUMENTATION</span>
            </a>
            <a class="col-12 col-md-2" href="/teamblog/">
              <span class="nav-link">BLOG</span>
            </a>
            
            <div class="col-12 col-md-2 hidden-sm-down">
              <div class="row justify-content-around align-items-center">
                <a href="https://twitter.com/kamonteam">
                  <i class="fa fa-twitter fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="https://github.com/kamon-io/Kamon">
                  <i class="fa fa-github fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="http://kamon.io/teamblog/rss/">
                  <i class="fa fa-rss fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="https://groups.google.com/forum/#!forum/kamon-user">
                  <i class="fa fa-envelope fa-lg nav-icon" aria-hidden="true"></i>
                </a>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</nav>
      <div class="hero jumbotron-top">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-7">
          <span class="jumbo-title">Documentation</span>
        </div>
      </div>
    </div>
  </div>  

    <div class="container">
      <div class="row">
        <div class="col-12 col-md-9 push-md-3">
          <div class="row align-items-center justify-content-end kamino-docs-top">
            <div>
                <a href="https://kamino.io">
                  <img class="img-fluid" alt="Sponsored by Kamino" src="/assets/img/sponsored-by-kamino.svg">
                </a>
            </div>
          </div>
          <div class="row docs-content">
            <div class="col-12">
              <h1 id="automatic-tracecontext-propagation">Automatic TraceContext Propagation</h1>

<p>Besides the metrics recording side of our Akka integration, we also provide bytecode instrumentation that will
automatically propagate the available <code>TraceContext</code> through certain specific events in order to keep the principle of
having a single and predictable place to look for the “current” context.</p>

<p>In the examples bellow we will explore the conditions under which Kamon will automatically propagate the currently
available context. Please note that even while in these examples we are explicitly wrapping the code sections with a new
<code>TraceContext</code>, it is very unlikely that you will need to do so yourself if you are using other supported toolkits such
as Spray and Play!. You will commonly need a context to be present only when the first event is generated and then Kamon will
take care of propagating the <code>TraceContext</code> to all related events, under the conditions explained bellow.</p>

<h3 id="tell--and-forward">Tell, ! and Forward</h3>

<p>If a <code>TraceContext</code> is available when sending a message to an actor, Kamon will capture that <code>TraceContext</code> and make it
available when processing that message in receiving actor, and <strong>only</strong> when processing that message. This remains true
regardless of whether your are doing a regular tell, using the <code>!</code> operator or forwarding a message to another actor.</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#scala_0_988234" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="scala_0_988234" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">  Tracer.withNewContext(&quot;sample-trace&quot;) {
    actor ! &quot;Some Message&quot;
    actor.tell(&quot;Some message&quot;, someSender)
  }
</code></pre></div></div></div>

<p>In this particular case, the two messages will propagate the same <code>TraceContext</code>, since they were originated from the
same block of code.</p>

<h3 id="ask-">Ask, ?</h3>

<p>When you send a message using the ask pattern the <code>TraceContext</code> is also propagated, but additionally the same <code>TraceContext</code>
is also available when executing any callbacks registered in the returned <code>Future</code>.</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#scala_0_488703" role="tab">Scala</a></li></ul><div class="tab-content"><div class="tab-pane active" id="scala_0_488703" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">  val responseFuture = Tracer.withNewContext(&quot;sample-trace&quot;) {
    (actor ? &quot;Ask Message&quot;)
      .mapTo[String]
      .map { response =&gt;
        // The same TraceContext available when asking
        // the actor is available when executing this callback.
        println(&quot;Context in MAP: &quot; + Tracer.currentContext)
      }
  }
</code></pre></div></div></div>

<h3 id="pipe-pattern">Pipe Pattern</h3>

<p>When using the pipe pattern, the <code>TraceContext</code> available when the pipe call was made (not when completing the future)
is also made available when processing the message in the target actor.</p>

<h3 id="log-events">Log Events</h3>

<p>When you are using the logging facilities provided by Akka, Kamon will attach the current <code>TraceContext</code> available when
the log statement is executed and make the same <code>TraceContext</code> available when that log event is actually processed by
your logger.</p>

<h3 id="supervision-messages">Supervision Messages</h3>

<p>When one of your actor fails it is the responsibility of its parent to determine what action to take based on the
provided supervision strategy. The failure notification as well as the delivery of the supervision directive to apply
happens through system messages that are not directly visible to users and do not use to the same mailbox as the regular
messages we send to actors, and Kamon hooks in these internals as well to propagate the <code>TraceContext</code>. It is really
important to keep the same <code>TraceContext</code> when this happens, since all possible error messages being logged or any other
action taken will be correctly related to the failing request.</p>

<h3 id="actor-creation">Actor Creation</h3>

<p>You might be thinking that actor creation happens in the same thread where the call to <code>ActorRefFactory.actorOf(..)</code> is
being made, but that is not necessarily true. In fact, a <code>Create</code> system message is sent to the newly created actor cell
and it might be execute later depending on whether you are creating a top-level actor or not. Kamon also instruments this
system message to make sure that if a <code>TraceContext</code> was available when requesting your <code>ActorRefFactory</code> to create an
actor, the same <code>TraceContext</code> will be available when that actor is actually created.</p>

<h2 id="crossing-the-jvm-borders">Crossing the JVM Borders</h2>

<p>If you are using Akka Remoting or the Akka Cluster, the same rules for <code>TraceContext</code> propagation apply but you will
need to ensure that the <code>kamon-akka-remote</code> module is in your classpath as well. Also, please note that not all the information
available locally for a <code>TraceContext</code> is propagated to remote actor systems, but rather a reduced subset that contains
the trace name, token, start timestamp and a whether the <code>TraceContext</code> is still open or not. Although that seems like a
very restrained set of information, by sending the trace token along you already have huge wins in terms of traceability
of actions across your distributed setup.</p>

            </div>
          </div>
          <!--<div class="row align-items-center kamino-docs-bottom">
            <div class="col-xs-offset-1 col-xs-5">
                <a href="http://kamino.io">
                  <img class="img-fluid" alt="Sponsored by Kamino" src="/assets/img/sponsored-by-kamino.svg">
                </a>
                <a class="btn btn-sign-up btn-lg">Visit kamino.io</a>
            </div>
          </div>-->
        </div>

        <div class="col-12 col-md-3 pull-md-9 documentation-sidebar">
          <section>
  <ul class="tree">
    <li><a class="docs-level-three side" href="/documentation/get-started/"></i>Get Started</a></li>
    <li><a class="docs-level-three side" href="/documentation/events-and-workshops/"></i>Upcoming Events</a></li>
  </ul>
</section>
          


<section>
  <div class="tree tree-toggler docs-level-one row justify-content-between align-items-center">
    <span>
      kamon-akka
    </span>

    <div class="dropdown version-dropdown">
      <a class="btn btn-secondary dropdown-toggle" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        0.6.6
      </a>

      <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
        
          <a class="dropdown-item" href="/documentation/kamon-akka/0.6.6/overview/">0.6.6</a>
        
      </div>
    </div>
  </div>

  <ul>
    
      <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/overview/">Overview</a></li>
    
      <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/actor-router-and-dispatcher-metrics/">Actor, Router and Dispatcher Metrics</a></li>
    
      <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/automatic-trace-context-propagation/">Automatic TraceContext Propagation</a></li>
    
      <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/ask-pattern-timeout-warning/">Ask Pattern Timeout Warning</a></li>
    

    
</section>
          <section>
  <div class="tree tree-toggler docs-level-one row align-items-center">
    <span>All Modules</span>
  </div>
  <ul class="tree tree-toggler">
    <li>
      <label class="tree-toggler tree docs-level-two">Foundations</label>
      <ul>
        <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/overview/">Metrics and Tracing</a></li>
      </ul>
    </li>

    <li>
      <label class="tree-toggler tree docs-level-two">Metrics Collection</label>
      <ul>
        <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/overview/">Akka</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-scala/0.6.6/overview/">Scala Futures</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-play/0.6.6/overview/">Play Framework</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-spray/0.6.6/overview/">Spray</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-jdbc/0.6.6/overview/">JDBC</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-annotation/0.6.6/overview/">Annotations</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-system-metrics/0.6.6/overview/">System Metrics</a></li>
      </ul>
    </li>

    <li>
      <label class="tree-toggler tree docs-level-two">Reporter Backends</label>
      <ul>
        <!--<li><a class="docs-level-three" href="/documentation/kamon-kamino/0.6.6/overview/">Kamino</a></li>-->
        <li><a class="docs-level-three" href="/documentation/kamon-statsd/0.6.6/overview/">StatsD</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-datadog/0.6.6/overview/">Datadog</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-newrelic/0.6.6/overview/">New Relic</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-sematext-spm/0.6.6/overview/">Sematext SPM</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-jmx/0.6.6/overview/">JMX</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-fluentd/0.6.6/overview/">FluentD</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-influxdb/0.6.6/overview/">InfluxDB</a></li>
        <!--<li><a class="docs-level-three" href="/documentation/kamon-graphite/1.0.4/overview/">Graphite</a></li>-->
        <li><a class="docs-level-three" href="/documentation/kamon-riemann/0.6.6/overview/">Riemann</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-khronus/0.6.6/overview/">Khronus</a></li>

      </ul>
    </li>    
  </ul>
</section>
        </div>

      </div>
    </div>

    <div class="hero jumbotron-bottom">
  <div class="container">
    <div class="row middle-xs">
      <div class="col-xs-12">
        
      </div>
    </div>
  </div>
</div>


<!--<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        <p class="text-center upper">
          Get in touch
        </p>
        <p class="text-center">
          <a href="https://twitter.com/kamonteam" class="social-icon"><i class="fa fa-twitter"></i></a>
          <a href="https://github.com/kamon-io/Kamon" class="social-icon"><i class="fa fa-2x fa-github"></i></a>
          <a href="/teamblog/rss/" class="social-icon"><i class="fa fa-rss"></i></a>
          <a href="https://groups.google.com/forum/#!forum/kamon-user" class="social-icon"><i class="fa fa-envelope"></i></a>
        </p>
        <p class="text-center">
          <a href="/introduction/project-info/support/" class="btn btn-support upper">Support <i class="fa fa-wrench"></i></a>
        </p>
        <p class="text-center">
          <img src="/assets/img/kamon-footer-logo.png" alt="logo" />
        </p>
        <p class="copyright">
          &copy; 2015 Kamon. All rights reserved.
        </p>
      </div>
    </div>
  </div>
</footer>-->



    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/assets/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/tether.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/prism-typesafeconfig.js"></script>
    <script>

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45369085-1', 'kamon.io');
    ga('send', 'pageview');

</script>

  </body>
</html>
