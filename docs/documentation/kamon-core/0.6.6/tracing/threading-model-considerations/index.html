<html lang="en">
  <head>
    <title>Kamon | Core | Documentation</title>

<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kamon is a set of tools that will help you monitor your reactive applications">

<!--<link rel="stylesheet" href="/assets/css/syntax-highlight.css">-->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/css/prism.css">
<link rel="stylesheet" href="/assets/css/styles.css">
<link rel="stylesheet" href="/assets/css/kamon.css">


<link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon">
<link href="https://plus.google.com/107736741680270898032?rel=author">
<link rel="alternate" type="application/rss+xml" title="Kamon Teamblog Feed" href="/teamblog/rss/">

<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

  </head>
  <body>
    <nav class="navbar navbar-default kamon-navbar">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-12 col-md-3">
          <a href="/documentation/get-started/">
            <img class="kamon-logo-image" alt="Kamon" src="/assets/img/kamon-logo-latest.svg">
          </a>
      </div>

      <div class="col-12 col-md-9">
        <div class="row justify-content-end align-items-center navigation-links">
            <div class="wip-warning col-12 col-md-4">
              WARNING: We are updating and fixing all docs around!
            </div>
            <a class="col-12 col-md-4 col-lg-3" href="/documentation/get-started/">
              <span class="nav-link">DOCUMENTATION</span>
            </a>
            <a class="col-12 col-md-2" href="/teamblog/">
              <span class="nav-link">BLOG</span>
            </a>
            
            <div class="col-12 col-md-2 hidden-sm-down">
              <div class="row justify-content-around align-items-center">
                <a href="https://twitter.com/kamonteam">
                  <i class="fa fa-twitter fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="https://github.com/kamon-io/Kamon">
                  <i class="fa fa-github fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="http://kamon.io/teamblog/rss/">
                  <i class="fa fa-rss fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="https://groups.google.com/forum/#!forum/kamon-user">
                  <i class="fa fa-envelope fa-lg nav-icon" aria-hidden="true"></i>
                </a>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</nav>
      <div class="hero jumbotron-top">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-7">
          <span class="jumbo-title">Documentation</span>
        </div>
      </div>
    </div>
  </div>  

    <div class="container">
      <div class="row">
        <div class="col-12 col-md-9 push-md-3">
          <div class="row align-items-center justify-content-end kamino-docs-top">
            <div>
                <a href="https://kamino.io">
                  <img class="img-fluid" alt="Sponsored by Kamino" src="/assets/img/sponsored-by-kamino.svg">
                </a>
            </div>
          </div>
          <div class="row docs-content">
            <div class="col-12">
              <h1 id="threading-model-considerations">Threading Model Considerations</h1>

<p>As described in the <a href="/core/tracing/trace-context-manipulation/">trace context manipulation</a> section, we will always use the <code>Tracer</code> companion object to store and
retrieve the <code>TraceContext</code> being used in the current trace. The <code>Tracer</code>, in turn, will end up storing the
<code>TraceContext</code> in a thread-local variable. This is, by far, the most simple and predictable way to share the
<code>TraceContext</code> across the entire code base, as well as providing third party libraries the ability to interact with it
as well. For this approach to succeed in your application you need to be completely aware of how the threading model of
your application works, sometimes the models are quite simple and single threaded, but it can get a lot more complex and
if you start to walk into event-based lands.</p>

<p>Here we will describe the three general threading models that we have identified and provide a bit of guidance with
regards to how the <code>TraceContext</code> should be manipulated and propagated across threads.</p>

<h2 id="the-traditional-model">The Traditional Model</h2>

<p><img class="img-fluid" src="/assets/img/diagrams/traditional-thread-model.png" /></p>

<p>The traditional way of doing things, specially when using Servlets, is to tie the execution of all code related to a
request to a single thread. In the picture above, the thick arrow in the background represents a thread while the blocks
in the foreground represents a piece of functionality in your application; that effectively means that if you do a JDBC
call to a database your request thread gets blocked until the response comes back from the database; if you send a HTTP
request to a external service using a blocking client, again, your thread will be blocked while waiting for the response
back from the external service. When everything happens in the same thread you don’t need to take any special
consideration, you simply use the tracing API and you are good to go.</p>

<h2 id="the-enhanced-traditional-model">The Enhanced Traditional Model</h2>

<p>Sometimes, waiting for everything to happen sequentially is not an option or it is even a requirement to do things
concurrently in order to minimize the experienced latency by the user. When doing so, the common approach is to add a
couple of fork points in the execution of a traditional flow, allowing some parts of the application code to execute
concurrently and then joining the results at some later point on the request thread. You are still blocking threads, in
fact, you are blocking more threads than with the traditional model, but you do it in such a way that the application
can serve a particular request “faster”. We tend to call this the “enhanced traditional model” and, to compare with the
traditional model you can picture it like this:</p>

<p><img class="img-fluid" src="/assets/img/diagrams/enhanced-traditional-thread-model.png" /></p>

<p>When your application works under this model you might have the need to propagate the <code>TraceContext</code> to the additional
supporting threads, it is up to you. If you need to do so, then rely on the tracing API to retrieve the current
<code>TraceContext</code> while you are still in the main thread and pass it to the task to be executed in the supporting thread.
It is very important that you clean up the supporting thread after you finish, as it might be used by a different trace
as soon as you release it.</p>

<h2 id="the-event-based-model">The Event Based Model</h2>

<p>When you walk into event based ground you need to be specially careful with regards to <code>TraceContext</code> propagation, since
it is very likely that the processing of a single request will trigger several asynchronous events that might be
processed by different threads at different points in time, until the request is fulfilled. Visually, the event based
model looks like this:</p>

<p><img class="img-fluid" src="/assets/img/diagrams/reactive-model.png" /></p>

<p>As you can see from the diagram, the processing of a request flows through a arbitrary number of stages and finishes at
some point in the future when the desired response is available. Some parts of the flow might still need to block a
thread, like when using JDBC to connect to a database, but still the majority of the the code is executed asynchronously
on different threads.</p>

<p>One important characteristic of this model is that even while things happen on different threads at unpredictable times,
usually, the processing of the first event related to a trace will trigger other events that are only related to this
specific trace and the cycle repeats. Under this model, the idea of threads is less important and you need to care about
how the <code>TraceContext</code> is tied to the events processed by your application.</p>

<p>Event based models are becoming more common nowadays and we already provide support for <a href="/integrations/scala/overview/">Scala</a> and <a href="/integrations/akka/overview/">Akka</a> event based
facilities, but in case you have a new tool at hand, the tracing API is there to help you!</p>


            </div>
          </div>
          <!--<div class="row align-items-center kamino-docs-bottom">
            <div class="col-xs-offset-1 col-xs-5">
                <a href="http://kamino.io">
                  <img class="img-fluid" alt="Sponsored by Kamino" src="/assets/img/sponsored-by-kamino.svg">
                </a>
                <a class="btn btn-sign-up btn-lg">Visit kamino.io</a>
            </div>
          </div>-->
        </div>

        <div class="col-12 col-md-3 pull-md-9 documentation-sidebar">
          <section>
  <ul class="tree">
    <li><a class="docs-level-three side" href="/documentation/get-started/"></i>Get Started</a></li>
    <li><a class="docs-level-three side" href="/documentation/events-and-workshops/"></i>Upcoming Events</a></li>
  </ul>
</section>
          


<section>
  <div class="tree tree-toggler docs-level-one row justify-content-between align-items-center">
    <span>
      kamon-core
    </span>

    <div class="dropdown version-dropdown">
      <a class="btn btn-secondary dropdown-toggle" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        0.6.6
      </a>

      <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
        
          <a class="dropdown-item" href="/documentation/kamon-core/0.6.6/overview/">0.6.6</a>
        
      </div>
    </div>
  </div>

  <ul>
    
      <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/overview/">Get Started</a></li>
    
      <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/configuration/">Configuring Kamon</a></li>
    

    
      <li>
      <label class="tree-toggler tree docs-level-two">Tracing</label>
      <ul class="tree tree-toggler">
        
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/core-concepts/">Core Concepts</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/subscription-protocol/">Subscription Protocol</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/threading-model-considerations/">Threading Model Considerations</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/trace-context-manipulation/">Trace Context Manipulation</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/trace-metrics/">Trace Metrics</a></li>
        
      </ul>
      </li>
    
      <li>
      <label class="tree-toggler tree docs-level-two">Metrics</label>
      <ul class="tree tree-toggler">
        
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/core-concepts/">Core Concepts</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/instruments/">Instruments</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/recording-metrics/">Recording Metrics</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/subscription-protocol/">Subscription Protocol</a></li>
        
      </ul>
      </li>
    
      <li>
      <label class="tree-toggler tree docs-level-two">Modules</label>
      <ul class="tree tree-toggler">
        
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/modules/using-modules/">Using Modules</a></li>
        
      </ul>
      </li>
    
</section>
          <section>
  <div class="tree tree-toggler docs-level-one row align-items-center">
    <span>All Modules</span>
  </div>
  <ul class="tree tree-toggler">
    <li>
      <label class="tree-toggler tree docs-level-two">Foundations</label>
      <ul>
        <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/overview/">Metrics and Tracing</a></li>
      </ul>
    </li>

    <li>
      <label class="tree-toggler tree docs-level-two">Metrics Collection</label>
      <ul>
        <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/overview/">Akka</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-scala/0.6.6/overview/">Scala Futures</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-play/0.6.6/overview/">Play Framework</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-spray/0.6.6/overview/">Spray</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-jdbc/0.6.6/overview/">JDBC</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-annotation/0.6.6/overview/">Annotations</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-system-metrics/0.6.6/overview/">System Metrics</a></li>
      </ul>
    </li>

    <li>
      <label class="tree-toggler tree docs-level-two">Reporter Backends</label>
      <ul>
        <!--<li><a class="docs-level-three" href="/documentation/kamon-kamino/0.6.6/overview/">Kamino</a></li>-->
        <li><a class="docs-level-three" href="/documentation/kamon-statsd/0.6.6/overview/">StatsD</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-datadog/0.6.6/overview/">Datadog</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-newrelic/0.6.6/overview/">New Relic</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-sematext-spm/0.6.6/overview/">Sematext SPM</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-jmx/0.6.6/overview/">JMX</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-fluentd/0.6.6/overview/">FluentD</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-influxdb/0.6.6/overview/">InfluxDB</a></li>
        <!--<li><a class="docs-level-three" href="/documentation/kamon-graphite/1.0.4/overview/">Graphite</a></li>-->
        <li><a class="docs-level-three" href="/documentation/kamon-riemann/0.6.6/overview/">Riemann</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-khronus/0.6.6/overview/">Khronus</a></li>

      </ul>
    </li>    
  </ul>
</section>
        </div>

      </div>
    </div>

    <div class="hero jumbotron-bottom">
  <div class="container">
    <div class="row middle-xs">
      <div class="col-xs-12">
        
      </div>
    </div>
  </div>
</div>


<!--<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        <p class="text-center upper">
          Get in touch
        </p>
        <p class="text-center">
          <a href="https://twitter.com/kamonteam" class="social-icon"><i class="fa fa-twitter"></i></a>
          <a href="https://github.com/kamon-io/Kamon" class="social-icon"><i class="fa fa-2x fa-github"></i></a>
          <a href="/teamblog/rss/" class="social-icon"><i class="fa fa-rss"></i></a>
          <a href="https://groups.google.com/forum/#!forum/kamon-user" class="social-icon"><i class="fa fa-envelope"></i></a>
        </p>
        <p class="text-center">
          <a href="/introduction/project-info/support/" class="btn btn-support upper">Support <i class="fa fa-wrench"></i></a>
        </p>
        <p class="text-center">
          <img src="/assets/img/kamon-footer-logo.png" alt="logo" />
        </p>
        <p class="copyright">
          &copy; 2015 Kamon. All rights reserved.
        </p>
      </div>
    </div>
  </div>
</footer>-->



    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/assets/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/tether.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/prism-typesafeconfig.js"></script>
    <script>

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45369085-1', 'kamon.io');
    ga('send', 'pageview');

</script>

  </body>
</html>
