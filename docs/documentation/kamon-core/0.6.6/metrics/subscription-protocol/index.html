<html lang="en">
  <head>
    <title>Kamon | Core | Documentation</title>

<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kamon is a set of tools that will help you monitor your reactive applications">

<!--<link rel="stylesheet" href="/assets/css/syntax-highlight.css">-->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/css/prism.css">
<link rel="stylesheet" href="/assets/css/styles.css">
<link rel="stylesheet" href="/assets/css/kamon.css">


<link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicon.ico" type="image/x-icon">
<link href="https://plus.google.com/107736741680270898032?rel=author">
<link rel="alternate" type="application/rss+xml" title="Kamon Teamblog Feed" href="/teamblog/rss/">

<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

  </head>
  <body>
    <nav class="navbar navbar-default kamon-navbar">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-12 col-md-3">
          <a href="/documentation/get-started/">
            <img class="kamon-logo-image" alt="Kamon" src="/assets/img/kamon-logo-latest.svg">
          </a>
      </div>

      <div class="col-12 col-md-9">
        <div class="row justify-content-end align-items-center navigation-links">
            <div class="wip-warning col-12 col-md-4">
              WARNING: We are updating and fixing all docs around!
            </div>
            <a class="col-12 col-md-4 col-lg-3" href="/documentation/get-started/">
              <span class="nav-link">DOCUMENTATION</span>
            </a>
            <a class="col-12 col-md-2" href="/teamblog/">
              <span class="nav-link">BLOG</span>
            </a>
            
            <div class="col-12 col-md-2 hidden-sm-down">
              <div class="row justify-content-around align-items-center">
                <a href="https://twitter.com/kamonteam">
                  <i class="fa fa-twitter fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="https://github.com/kamon-io/Kamon">
                  <i class="fa fa-github fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="http://kamon.io/teamblog/rss/">
                  <i class="fa fa-rss fa-lg nav-icon" aria-hidden="true"></i>
                </a>
                <a href="https://groups.google.com/forum/#!forum/kamon-user">
                  <i class="fa fa-envelope fa-lg nav-icon" aria-hidden="true"></i>
                </a>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</nav>
      <div class="hero jumbotron-top">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-7">
          <span class="jumbo-title">Documentation</span>
        </div>
      </div>
    </div>
  </div>  

    <div class="container">
      <div class="row">
        <div class="col-12 col-md-9 push-md-3">
          <div class="row align-items-center justify-content-end kamino-docs-top">
            <div>
                <a href="https://kamino.io">
                  <img class="img-fluid" alt="Sponsored by Kamino" src="/assets/img/sponsored-by-kamino.svg">
                </a>
            </div>
          </div>
          <div class="row docs-content">
            <div class="col-12">
              <h1 id="metrics-subscription-protocol">Metrics Subscription Protocol</h1>

<p>The Metrics subscriptions protocol provides you a simple way to tell the Kamon metrics module that you are interested in
receiving entity snapshots for a selection of entities upon every tick. You can subscribe to metrics by calling any of
the <code>subscribe</code> method variants in the metrics module, specifying the category and name pattern for the entities of
you are interest in and the Akka actor that will receive the metrics information on every tick. On real code,
subscriptions look like this:</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#scala_0_226877" role="tab">Scala</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#java_1_226877" role="tab">Java</a></li></ul><div class="tab-content"><div class="tab-pane active" id="scala_0_226877" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">  Kamon.metrics.subscribe(&quot;trace&quot;, &quot;test-trace&quot;, subscriber)
  Kamon.metrics.subscribe(&quot;trace&quot;, &quot;test-*&quot;, subscriber)
  Kamon.metrics.subscribe(&quot;trace&quot;, &quot;**&quot;, subscriber)
</code></pre></div><div class="tab-pane" id="java_1_226877" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">    Kamon.metrics().subscribe(&quot;trace&quot;, &quot;test-trace&quot;, subscriber);
    Kamon.metrics().subscribe(&quot;trace&quot;, &quot;test-*&quot;, subscriber);
    Kamon.metrics().subscribe(&quot;trace&quot;, &quot;**&quot;, subscriber);
</code></pre></div></div></div>

<p>Regardless of how many subscriptions you do or if an entity matches several of the provided subscription patterns (as
the “test-trace” does in this example), each subscriber will receive a single <code>TickMetricSnasphot</code> message containing
all the entities matched by it’s subscriptions on every tick.</p>

<p>The <code>TickMetricSnapshot</code> message received by all subscribers contains the from and to timestamps and a immutable map
from entities to entity snapshots with all the measurements recorded by all the matched entities since the last tick to
the current one. The entity snapshots are the immutable counterpart of the entity recorders discussed in the <a href="/core/metrics/core-concepts/">core
concepts</a> section; while the entity recorders are considered unstable because their state changes as your application’s
behavior is being measured, the entity snapshots are freely shareable because once created their state will never
change.</p>

<p>Each <code>EntitySnapshot</code> simply contains a map from <code>MetricKey</code> to <code>InstrumentSnapshot</code>. Metric keys are used to identify
each of the metrics being tracked for a given entity both in the mutable side as well as in the immutable side of Kamon
and the consist of the following attributes:</p>

<ul>
  <li>
    <p><strong>name</strong>: A simple text describing the metric being tracked for that entity. In the cases of traces and segments you
will always find the <code>elapsed-time</code> metric inside the correspondent entity snapshot, or in your own custom entity
recorders you will find the metric keys with the very same name that you provided when defining the entity recorder. In
the case of single instrument recorders as the ones used to support simple histograms, counters and so on, you will find
a single metric key in each entity snapshot, named after the contained instrument type; for a histogram entity snapshot
there will be single metric named <code>histogram</code>, for a counter entity snapshot there will be a single metric named
<code>counter</code>, and the same applies for min max counters and gauges.</p>
  </li>
  <li>
    <p><strong>unit of measurement</strong>: optional, it describes what kind of values are being recorded in the given instrument. This
member will usually be useful for metric backends as they might need to scale the reported values from the originally
measured unit to the one supported by the backend. If not provided then Kamon will use <code>UnitOfMeasurement.Unknown</code> as
the default value.</p>
  </li>
</ul>

<h2 id="creating-a-simple-subscriber">Creating a Simple Subscriber</h2>
<p>Before moving forward, please keep in mind that the process described bellow covers the case in which your application
will make use of the metrics information collected by Kamon in order to provide some functionality, be it load
balancing, throttling or the like. If your intention is to integrate Kamon with a metric backend then try out this
example and then move on to the <a href="/core/creating-modules/reporting-modules/">creating reporting modules</a> section which is more appropriate for the task.</p>

<p>The best way to understand how the subscriptions and snapshots work is with a simple example; here we will create a very
simple subscriber that displays all counters and a specific histogram in the console upon every tick.</p>

<p>First, we need to define our subscriber actor’s behavior, it will simply wait for <code>TickMetricSnapshot</code> messages as
described above and print all counters and histograms included in the message. Wait, wasn’t it just for a single
histogram?, yes, it is! but you can subscribe to one specific histogram entity while still keeping the subscriber code
able to handle more than one histogram in case you decide to do so in the future. This is how the subscriber should look
like:</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#scala_0_91627" role="tab">Scala</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#java_1_91627" role="tab">Java</a></li></ul><div class="tab-content"><div class="tab-pane active" id="scala_0_91627" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">class SimplePrinter extends Actor {
  def receive = {
    case tickSnapshot: TickMetricSnapshot =&gt;
      val counters = tickSnapshot.metrics.filterKeys(_.category == &quot;counter&quot;)
      val histograms = tickSnapshot.metrics.filterKeys(_.category == &quot;histogram&quot;)

      println(&quot;#################################################&quot;)
      println(&quot;From: &quot; + tickSnapshot.from)
      println(&quot;To: &quot; + tickSnapshot.to)

      counters.foreach { case (e, s) =&gt;
        val counterSnapshot = s.counter(&quot;counter&quot;).get
        println(&quot;Counter [%s] was incremented [%d] times.&quot;.format(e.name, counterSnapshot.count))
      }

      histograms.foreach { case (e, s) =&gt;
        val histogramSnapshot = s.histogram(&quot;histogram&quot;).get
        println(&quot;Histogram [%s] has [%d] recordings.&quot;.format(e.name, histogramSnapshot.numberOfMeasurements))
      }
  }
}
</code></pre></div><div class="tab-pane" id="java_1_91627" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">  public static class SimplePrinter extends UntypedActor {

    @Override
    public void onReceive(Object message) throws Exception {
      if(message instanceof TickMetricSnapshot) {
        final TickMetricSnapshot tickSnapshot = (TickMetricSnapshot) message;
        final Map&lt;Entity, EntitySnapshot&gt; counters = filterCategory(&quot;counter&quot;, tickSnapshot);
        final Map&lt;Entity, EntitySnapshot&gt; histograms = filterCategory(&quot;histogram&quot;, tickSnapshot);

        System.out.println(&quot;#################################################&quot;);
        System.out.println(&quot;From: &quot; + tickSnapshot.from());
        System.out.println(&quot;To: &quot; + tickSnapshot.to());

        counters.forEach((e, s) -&gt; {
          final Counter.Snapshot counterSnapshot = s.counter(&quot;counter&quot;).get();
          System.out.println(String.format(&quot;Counter [%s] was incremented [%d] times.&quot;, e.name(), counterSnapshot.count()));
        });

        histograms.forEach((e, s) -&gt; {
          final Histogram.Snapshot histogramSnapshot = s.histogram(&quot;histogram&quot;).get();
          System.out.println(String.format(&quot;Histogram [%s] has [%d] recordings.&quot;, e.name(), histogramSnapshot.numberOfMeasurements()));
        });


      } else unhandled(message);
    }

    private Map&lt;Entity, EntitySnapshot&gt; filterCategory(String categoryName, TickMetricSnapshot snapshot) {
      return Maps.filterKeys(mapAsJavaMap(snapshot.metrics()), (e) -&gt; e.category().equals(categoryName));
    }
  }
</code></pre></div></div></div>

<p>After you have defined your subscriber actor then you need to create the correspondent actor instance and use it to
subscribe to the counters and the histogram data we are interested in. If we want to receive all counters but only the
histogram named <code>test-histogram</code> then the subscriptions should look like this:</p>

<div class="code-example"><ul class="nav nav-tabs language-tab justify-content-end" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#scala_0_18430" role="tab">Scala</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#java_1_18430" role="tab">Java</a></li></ul><div class="tab-content"><div class="tab-pane active" id="scala_0_18430" role="tabpanel"><pre class="line-numbers language-scala"><code class="language-scala">  Kamon.metrics.subscribe(&quot;counter&quot;, &quot;**&quot;, subscriber)
  Kamon.metrics.subscribe(&quot;histogram&quot;, &quot;test-histogram&quot;, subscriber)
</code></pre></div><div class="tab-pane" id="java_1_18430" role="tabpanel"><pre class="line-numbers language-java"><code class="language-java">    Kamon.metrics().subscribe(&quot;counter&quot;, &quot;**&quot;, subscriber);
    Kamon.metrics().subscribe(&quot;histogram&quot;, &quot;test-histogram&quot;, subscriber);
</code></pre></div></div></div>

<p>And that’s it! Depending on what you intent to do with the metrics information the amount of code in your subscriber
will vary, but the basic steps will remain the same:</p>

<ol>
  <li>Create an actor that knows how to handle <code>TickMetricSnapshot</code> messages.</li>
  <li>Subscribe it to the desired entities using the <code>Kamon.metrics.subscribe(..)</code> method.</li>
  <li>Profit!</li>
</ol>


            </div>
          </div>
          <!--<div class="row align-items-center kamino-docs-bottom">
            <div class="col-xs-offset-1 col-xs-5">
                <a href="http://kamino.io">
                  <img class="img-fluid" alt="Sponsored by Kamino" src="/assets/img/sponsored-by-kamino.svg">
                </a>
                <a class="btn btn-sign-up btn-lg">Visit kamino.io</a>
            </div>
          </div>-->
        </div>

        <div class="col-12 col-md-3 pull-md-9 documentation-sidebar">
          <section>
  <ul class="tree">
    <li><a class="docs-level-three side" href="/documentation/get-started/"></i>Get Started</a></li>
    <li><a class="docs-level-three side" href="/documentation/events-and-workshops/"></i>Upcoming Events</a></li>
  </ul>
</section>
          


<section>
  <div class="tree tree-toggler docs-level-one row justify-content-between align-items-center">
    <span>
      kamon-core
    </span>

    <div class="dropdown version-dropdown">
      <a class="btn btn-secondary dropdown-toggle" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        0.6.6
      </a>

      <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
        
          <a class="dropdown-item" href="/documentation/kamon-core/0.6.6/overview/">0.6.6</a>
        
      </div>
    </div>
  </div>

  <ul>
    
      <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/overview/">Get Started</a></li>
    
      <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/configuration/">Configuring Kamon</a></li>
    

    
      <li>
      <label class="tree-toggler tree docs-level-two">Tracing</label>
      <ul class="tree tree-toggler">
        
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/core-concepts/">Core Concepts</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/subscription-protocol/">Subscription Protocol</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/threading-model-considerations/">Threading Model Considerations</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/trace-context-manipulation/">Trace Context Manipulation</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/tracing/trace-metrics/">Trace Metrics</a></li>
        
      </ul>
      </li>
    
      <li>
      <label class="tree-toggler tree docs-level-two">Metrics</label>
      <ul class="tree tree-toggler">
        
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/core-concepts/">Core Concepts</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/instruments/">Instruments</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/recording-metrics/">Recording Metrics</a></li>
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/metrics/subscription-protocol/">Subscription Protocol</a></li>
        
      </ul>
      </li>
    
      <li>
      <label class="tree-toggler tree docs-level-two">Modules</label>
      <ul class="tree tree-toggler">
        
        
          <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/modules/using-modules/">Using Modules</a></li>
        
      </ul>
      </li>
    
</section>
          <section>
  <div class="tree tree-toggler docs-level-one row align-items-center">
    <span>All Modules</span>
  </div>
  <ul class="tree tree-toggler">
    <li>
      <label class="tree-toggler tree docs-level-two">Foundations</label>
      <ul>
        <li><a class="docs-level-three" href="/documentation/kamon-core/0.6.6/overview/">Metrics and Tracing</a></li>
      </ul>
    </li>

    <li>
      <label class="tree-toggler tree docs-level-two">Metrics Collection</label>
      <ul>
        <li><a class="docs-level-three" href="/documentation/kamon-akka/0.6.6/overview/">Akka</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-scala/0.6.6/overview/">Scala Futures</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-play/0.6.6/overview/">Play Framework</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-spray/0.6.6/overview/">Spray</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-jdbc/0.6.6/overview/">JDBC</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-annotation/0.6.6/overview/">Annotations</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-system-metrics/0.6.6/overview/">System Metrics</a></li>
      </ul>
    </li>

    <li>
      <label class="tree-toggler tree docs-level-two">Reporter Backends</label>
      <ul>
        <!--<li><a class="docs-level-three" href="/documentation/kamon-kamino/0.6.6/overview/">Kamino</a></li>-->
        <li><a class="docs-level-three" href="/documentation/kamon-statsd/0.6.6/overview/">StatsD</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-datadog/0.6.6/overview/">Datadog</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-newrelic/0.6.6/overview/">New Relic</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-sematext-spm/0.6.6/overview/">Sematext SPM</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-jmx/0.6.6/overview/">JMX</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-fluentd/0.6.6/overview/">FluentD</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-influxdb/0.6.6/overview/">InfluxDB</a></li>
        <!--<li><a class="docs-level-three" href="/documentation/kamon-graphite/1.0.4/overview/">Graphite</a></li>-->
        <li><a class="docs-level-three" href="/documentation/kamon-riemann/0.6.6/overview/">Riemann</a></li>
        <li><a class="docs-level-three" href="/documentation/kamon-khronus/0.6.6/overview/">Khronus</a></li>

      </ul>
    </li>    
  </ul>
</section>
        </div>

      </div>
    </div>

    <div class="hero jumbotron-bottom">
  <div class="container">
    <div class="row middle-xs">
      <div class="col-xs-12">
        
      </div>
    </div>
  </div>
</div>


<!--<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        <p class="text-center upper">
          Get in touch
        </p>
        <p class="text-center">
          <a href="https://twitter.com/kamonteam" class="social-icon"><i class="fa fa-twitter"></i></a>
          <a href="https://github.com/kamon-io/Kamon" class="social-icon"><i class="fa fa-2x fa-github"></i></a>
          <a href="/teamblog/rss/" class="social-icon"><i class="fa fa-rss"></i></a>
          <a href="https://groups.google.com/forum/#!forum/kamon-user" class="social-icon"><i class="fa fa-envelope"></i></a>
        </p>
        <p class="text-center">
          <a href="/introduction/project-info/support/" class="btn btn-support upper">Support <i class="fa fa-wrench"></i></a>
        </p>
        <p class="text-center">
          <img src="/assets/img/kamon-footer-logo.png" alt="logo" />
        </p>
        <p class="copyright">
          &copy; 2015 Kamon. All rights reserved.
        </p>
      </div>
    </div>
  </div>
</footer>-->



    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/assets/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/assets/js/tether.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/prism-typesafeconfig.js"></script>
    <script>

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45369085-1', 'kamon.io');
    ga('send', 'pageview');

</script>

  </body>
</html>
